#!/bin/sh

source ~/.not_for_git.sh

api() {
  echo $(curl -s --request GET \
     --url https://api.themoviedb.org/3/$1 \
     --header "Authorization: Bearer $TMDB_KEY" \
     --header 'accept: application/json')
}

zero_in() {
  echo $DATA | grep -Po "(?<=\"$1\":).*(?=,\"$2\":)" | grep -Po "(?<=\"$3\")[^\]\}]*" | grep -Po "(?<=\")(.[^\:]*?)(?=\")"
}

INPUT=$(echo $1 | tr _ %20)

ID=$(echo $(echo $(api search/movie?query=$INPUT) | grep -Po '(?<="id":).[^,]*') | cut -d" " -f1)
DATA=$(api movie/$ID)

GENRES=$(echo $(zero_in genres homepage name) | awk '{print tolower($0)}')
COUNTRY=$(echo $(zero_in imdb_id original_language origin_country) | awk '{print tolower($0)}')
RELEASE_DATE=$(echo $(zero_in production_countries revenue release_date))
POSTER=$(echo https://image.tmdb.org/t/p/w780$(zero_in popularity production_companies poster_path))
POPULARITY=$(echo $DATA | grep -Po '(?<="vote_average":).[^,]*')

echo "
---
date: $2
release date: $RELEASE_DATE
country: $COUNTRY
tags:
  - $(echo $GENRES | cut -d' ' -f1)
  - $(echo $GENRES | cut -d' ' -f2)
  - $(echo $GENRES | cut -d' ' -f3)
imdb: $(echo https://www.themoviedb.org/movie/$ID)
cover: $POSTER
tmdb_average_vote: $POPULARITY
dont display:
  - tags
---
\`%PROPERTIES\`
"
