#!/bin/sh

source ~/.not_for_git.sh

api() {
  echo $(curl -s --request GET \
     --url https://api.themoviedb.org/3/$1 \
     --header "Authorization: Bearer $TMDB_KEY" \
     --header 'accept: application/json')
}

get_id() {
  $(echo $(api search/movie?query=$INPUT) | grep -Po '(?<="id":).[^,]*') | cut -d" " -f$1
}

INPUT=$(echo $1 | tr _ %20)
TARGET_RELEASE_YEAR=$3
RELEASE_DATE=0

# recursively search for movies to match input year ($3)
i=1
while [ "$(echo $RELEASE_DATE | cut -d'-' -f1)" != "$TARGET_RELEASE_YEAR" ]; do
  ID=$(echo $(echo $(api search/movie?query=$INPUT) | grep -Po '(?<="id":).[^,]*') | cut -d" " -f$i)
  RELEASE_DATE=$(echo $(echo $(api movie/$ID) | grep -Po '(?<=release_date":").[^\"]*'))
  if [[ -z "$TARGET_RELEASE_DATE" ]]; then
     TARGET_RELEASE_YEAR="$(echo $RELEASE_DATE | cut -d'-' -f1)"
  fi
  ((i++))
done

tmdbid $ID
